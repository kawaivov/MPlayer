<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resilient Client Demo</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .banner { background: #ffebee; color: #c62828; padding: 1rem; margin-bottom: 1rem; border: 1px solid #ef9a9a; display: none; border-radius: 4px;}
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        input { padding: 8px; flex-grow: 1; }
        button { padding: 8px 16px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #logs { background: #f5f5f5; padding: 1rem; border-radius: 4px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #e0e0e0; padding-bottom: 2px; }
        .success { color: green; }
        .error { color: red; }
        .retry { color: orange; }
    </style>
</head>
<body>

    <h1>Resilient Client Demo</h1>
    
    <div id="degradedBanner" class="banner">
        <strong>‚ö†Ô∏è –£–≤–∞–≥–∞:</strong> –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –≤ –æ–±–º–µ–∂–µ–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º–∏ –∑—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è–º. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.
    </div>

    <div class="controls">
        <input type="text" id="orderTitle" placeholder="–ù–∞–∑–≤–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–Ω–∞–ø—Ä. Buy Milk)">
        <button id="submitBtn" onclick="createOrder()">Create Order</button>
        <button onclick="checkHealth()">Check Health</button>
    </div>

    <div id="logs"></div>

    <script type="module">
        // --- Conf ---
        const API_URL = "http://localhost:8081";
        const STATE = {
            consecutiveFailures: 0,
            degradedThreshold: 3, // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è degraded mode
            isDegraded: false
        };

        // --- Helpers ---
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        
        // –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–∏–π backoff –∑ –¥–∂–∏—Ç–µ—Ä–æ–º
        const backoff = (base, attempt) => {
            const jitter = Math.floor(Math.random() * 100);
            return base * (2 ** attempt) + jitter;
        };

        const log = (msg, type = '') => {
            const el = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `<div class="log-entry ${type}">[${time}] ${msg}</div>` + el.innerHTML;
        };

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI –¥–ª—è Degraded Mode
        const updateDegradedState = (isFailure) => {
            if (isFailure) {
                STATE.consecutiveFailures++;
            } else {
                STATE.consecutiveFailures = 0;
                if (STATE.isDegraded) {
                    STATE.isDegraded = false;
                    document.getElementById('degradedBanner').style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                    log("üü¢ System recovered. Degraded mode OFF.", "success");
                }
            }

            if (!STATE.isDegraded && STATE.consecutiveFailures >= STATE.degradedThreshold) {
                STATE.isDegraded = true;
                document.getElementById('degradedBanner').style.display = 'block';
                // –î–∏–∑–µ–π–±–ª–∏–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —á–∞—Å, —â–æ–± –¥–∞—Ç–∏ —Å–∏—Å—Ç–µ–º—ñ "–æ—Å—Ç–∏–≥–Ω—É—Ç–∏"
                document.getElementById('submitBtn').disabled = true;
                log("üî¥ System unstable. Entering DEGRADED MODE.", "error");
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–∞–ª–µ –±–∞–Ω–µ—Ä –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –¥–æ —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É)
                setTimeout(() => {
                    if (STATE.isDegraded) document.getElementById('submitBtn').disabled = false;
                }, 5000);
            }
        };

        // --- Idempotency Utils ---
        async function getPayloadHash(payload) {
            const msgBuffer = new TextEncoder().encode(JSON.stringify(payload));
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function getIdempotencyKey(payload) {
            const hash = await getPayloadHash(payload);
            const storageKey = `idem:${hash}`;
            let key = localStorage.getItem(storageKey);
            if (!key) {
                key = crypto.randomUUID();
                localStorage.setItem(storageKey, key);
            }
            return key;
        }

        // --- FETCH WITH RESILIENCE ---
        async function fetchWithResilience(url, options = {}) {
            const { retry = {}, ...fetchOptions } = options;
            const { 
                retries = 3, 
                baseDelayMs = 500, 
                timeoutMs = 3000 
            } = retry;

            const headers = new Headers(fetchOptions.headers || {});
            // –î–æ–¥–∞—î–º–æ –∫–æ—Ä–µ–ª—è—Ü—ñ–π–Ω–∏–π ID –∫–ª—ñ—î–Ω—Ç–∞, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
            if (!headers.has('X-Request-Id')) {
                headers.set('X-Request-Id', crypto.randomUUID());
            }

            const attempt = options.__attempt || 0;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                log(`Attempt ${attempt + 1}/${retries + 1} -> ${url}...`);
                
                const res = await fetch(url, { 
                    ...fetchOptions, 
                    headers, 
                    signal: controller.signal 
                });

                clearTimeout(timeoutId);

                // Handling 429 Too Many Requests
                if (res.status === 429) {
                    const retryAfterSec = parseInt(res.headers.get('Retry-After') || '1', 10);
                    log(`‚ö†Ô∏è 429 Rate Limit. Waiting ${retryAfterSec}s...`, 'retry');
                    
                    if (attempt < retries) {
                        await sleep(retryAfterSec * 1000);
                        return fetchWithResilience(url, { ...options, __attempt: attempt }); // –ù–µ –∑–±—ñ–ª—å—à—É—î–º–æ attempt –¥–ª—è rate limit, –∞–±–æ –∑–±—ñ–ª—å—à—É—î–º–æ –∑–∞ –ª–æ–≥—ñ–∫–æ—é
                    }
                }

                // Handling 5xx Server Errors
                if (res.status >= 500 && attempt < retries) {
                    const delay = backoff(baseDelayMs, attempt);
                    log(`‚ö†Ô∏è Server Error (${res.status}). Retrying in ${delay}ms...`, 'retry');
                    await sleep(delay);
                    return fetchWithResilience(url, { ...options, __attempt: attempt + 1 });
                }

                if (!res.ok) {
                     // –Ü–Ω—à—ñ –ø–æ–º–∏–ª–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞ (400, 401 —Ç–æ—â–æ) –Ω–µ —Ä–µ—Ç—Ä–∞—ó–º–æ
                    const errorBody = await res.json().catch(() => ({}));
                    throw { status: res.status, ...errorBody };
                }

                updateDegradedState(false); // –£—Å–ø—ñ—Ö - —Å–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∑–±–æ—ó–≤
                return res;

            } catch (err) {
                clearTimeout(timeoutId);
                const isAbort = err.name === 'AbortError';
                const errMsg = isAbort ? 'Timeout' : (err.message || 'Network Error');
                
                log(`‚ùå Error: ${errMsg}`, 'error');

                if (attempt < retries && (isAbort || err.name === 'TypeError')) {
                    // –†–µ—Ç—Ä–∞—ó–º–æ –º–µ—Ä–µ–∂–µ–≤—ñ –ø–æ–º–∏–ª–∫–∏ —ñ —Ç–∞–π–º–∞—É—Ç–∏
                    const delay = backoff(baseDelayMs, attempt);
                    log(`üîÑ Retrying network/timeout issue in ${delay}ms...`, 'retry');
                    await sleep(delay);
                    return fetchWithResilience(url, { ...options, __attempt: attempt + 1 });
                }

                updateDegradedState(true); // –ö—Ä–∏—Ç–∏—á–Ω–∏–π –∑–±—ñ–π
                throw err;
            }
        }

        // --- Main Logic ---

        window.createOrder = async () => {
            const titleInput = document.getElementById('orderTitle');
            const title = titleInput.value || "Untitled Order";
            const payload = { title };
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –∞–±–æ —Å—Ç–≤–æ—Ä—é—î–º–æ –∫–ª—é—á –¥–ª—è —Ü—å–æ–≥–æ payload
            const idemKey = await getIdempotencyKey(payload);
            log(`üîë Idempotency Key: ${idemKey.slice(0, 8)}...`);

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;

            try {
                const res = await fetchWithResilience(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Idempotency-Key': idemKey
                    },
                    body: JSON.stringify(payload),
                    retry: { retries: 3, baseDelayMs: 300, timeoutMs: 2000 }
                });

                const data = await res.json();
                const cachedMsg = data.cached ? " (From Cache)" : "";
                log(`‚úÖ Order Success: ${data.id}${cachedMsg}. RequestID: ${data.requestId}`, 'success');
                
            } catch (e) {
                log(`‚õî Final Failure: ${JSON.stringify(e)}`, 'error');
            } finally {
                if(!STATE.isDegraded) btn.disabled = false;
            }
        };

        window.checkHealth = async () => {
            try {
                // Health check –∑ –¥—É–∂–µ –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º (1—Å)
                const res = await fetchWithResilience(`${API_URL}/health`, {
                    retry: { retries: 0, timeoutMs: 1000 }
                });
                const data = await res.json();
                log(`‚ù§Ô∏è Health: ${data.status}`, 'success');
            } catch (e) {
                log(`üíî Health Check Failed`, 'error');
            }
        };
    </script>
</body>
</html>